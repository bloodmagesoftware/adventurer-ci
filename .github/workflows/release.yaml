name: External Pogo Build

on:
  repository_dispatch:
    types: [pogo_trigger]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Webhook Secret
        env:
          EXPECTED_SECRET: ${{ secrets.POGO_WEBHOOK_SECRET }}
          PAYLOAD_SECRET: ${{ github.event.client_payload.auth_secret }}
        run: |
          if [ "$PAYLOAD_SECRET" != "$EXPECTED_SECRET" ]; then
            echo "::error::⛔ Security validation failed! Invalid secret."
            exit 1
          fi
          echo "✅ Secret validated. Payload authorized."

  build:
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows x86_64
            venture: venture-windows-x64.exe
          - os: macos-latest
            name: macOS ARM64
            venture: venture-darwin-arm64
          - os: ubuntu-latest
            name: Ubuntu x86_64
            venture: venture-linux-cli-x86_64

    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Download Source from Pogo VCS
        shell: bash
        run: |
          echo "⬇️ Downloading source for version ${{ github.event.client_payload.version }}..."
          curl -H "Authorization: ${{ github.event.client_payload.pogo_token }}" -L "${{ github.event.client_payload.source_url }}" -o source.zip

      - name: Extract Source
        shell: bash
        run: |
          unzip -q source.zip -d pogo_repository

      - name: Download Venture
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p "$GITHUB_WORKSPACE/bin"
          if [ "${{ runner.os }}" == "Windows" ]; then
          gh release download --repo tsukinoko-kun/venture --pattern '${{ matrix.venture }}' --output "$GITHUB_WORKSPACE/bin/venture.exe" --clobber
          else
          gh release download --repo tsukinoko-kun/venture --pattern '${{ matrix.venture }}' --output "$GITHUB_WORKSPACE/bin/venture" --clobber
          chmod +x "$GITHUB_WORKSPACE/bin/venture"
          fi
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Setup Odin
        uses: laytan/setup-odin@v1

      - name: Setup SDL3 Dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          echo "Installing SDL3 libraries via Homebrew..."
          brew install sdl3 sdl3_image sdl3_ttf dylibbundler

      - name: Setup SDL3 (Linux/Windows)
        if: runner.os != 'macOS'
        id: sdl
        uses: libsdl-org/setup-sdl@main
        with:
          version: 3-latest
          version-sdl-image: 3-latest
          version-sdl-ttf: 3-latest
          install-linux-dependencies: true
          add-to-environment: true
          cache: true

      - name: Setup SDL3 for linkers (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "LIBRARY_PATH=${{ steps.sdl.outputs.prefix }}/lib" >> $GITHUB_ENV
          echo "CPATH=${{ steps.sdl.outputs.prefix }}/include" >> $GITHUB_ENV
          echo "${{ steps.sdl.outputs.prefix }}/bin" >> $GITHUB_PATH

      - name: Setup SDL3 for linkers (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "LIBRARY_PATH=$SDL3_ROOT/lib:$SDL3_image_ROOT/lib:$SDL3_ttf_ROOT/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$SDL_PREFIX/lib:$SDL_PREFIX/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "CPATH=$SDL3_ROOT/include:$SDL3_image_ROOT/include:$SDL3_ttf_ROOT/include:$CPATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$SDL_PREFIX/lib/pkgconfig:$SDL_PREFIX/lib64/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Install LinuxDeploy (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # 1. Install libfuse2 (Required for AppImages on Ubuntu 22.04+)
          sudo apt-get update && sudo apt-get install -y libfuse2

          # 2. Download linuxdeploy from the official release
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage

          # 3. Rename, make executable, and move to system bin
          chmod +x linuxdeploy-x86_64.AppImage
          sudo mv linuxdeploy-x86_64.AppImage /usr/local/bin/linuxdeploy

      - name: Build Game
        working-directory: pogo_repository
        run: venture build

      - name: Identify and Upload Artifact
        shell: bash
        run: |
          ls -R pogo_repository
          cd pogo_repository/build
          FILE_NAME=$(ls)
          echo "Found build output: $FILE_NAME"
          echo "ARTIFACT_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "ARTIFACT_PATH=pogo_repository/build/$FILE_NAME" >> $GITHUB_ENV

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          # Uses the actual filename (e.g. adventurer-darwin_arm64.zip) as the artifact name
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          if-no-files-found: error
          retention-days: 1

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.client_payload.version }}
        run: |
          echo "Creating release for version $VERSION..."
          ls -R all_artifacts
          gh release create "$VERSION" all_artifacts/* \
            --title "Release $VERSION" \
            --notes "Automated release triggered via Pogo." \
            --generate-notes
